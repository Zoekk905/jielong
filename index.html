<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>微信接龙自动分组</title>
<style>
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",Arial;
  background:#f6f7f9;
  color:#222;
}

.wrap{
  max-width:1100px;
  margin:24px auto;
  padding:0 16px;
}

h1{
  font-size:22px;
  margin:0 0 6px;
}

.sub{
  color:#555;
  font-size:13px;
  margin-bottom:14px;
}

.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:16px;
  margin-bottom:14px;
}

textarea{
  width:100%;
  min-height:220px;
  padding:12px 14px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
  line-height:1.6;
  resize:vertical;
  background:#fff;
  outline:none;
}
textarea:focus{ border-color:#4c8bf5; }

textarea.small{
  min-height:120px;
}

.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}

button{
  padding:7px 14px;
  border-radius:6px;
  border:1px solid #4c8bf5;
  background:#4c8bf5;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

button.secondary{
  background:#fff;
  color:#333;
  border:1px solid #ccc;
}

label{
  font-size:13px;
  color:#444;
  display:flex;
  align-items:center;
  gap:6px;
}

input[type="number"]{
  width:110px;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #ccc;
}

.groups{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:12px;
}

.gcard{
  border:1px solid #ddd;
  border-radius:8px;
  background:#fff;
  overflow:hidden;
}

.ghead{
  background:#f3f3f3;
  border-bottom:1px solid #ddd;
  padding:8px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  gap:10px;
}

.ghead .left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid #d0d0d0;
  background:#fff;
  font-size:12px;
  color:#333;
  white-space:nowrap;
}
.badge b{ font-weight:700; }

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  border:1px solid #ddd;
  padding:7px 9px;
  font-size:14px;
}

th{
  background:#f6f6f6;
  text-align:left;
}

td.num,th.num{
  text-align:right;
  width:100px;
}

td.seq,th.seq{
  text-align:right;
  width:70px;
  color:#666;
}

.ok{color:#2e8b57;}
.warn{color:#c0392b;}

.note{
  font-size:13px;
  color:#666;
  margin-top:10px;
  line-height:1.5;
}
.note .warn{font-weight:700;}
</style>
</head>

<body>
<div class="wrap">
  <h1>微信接龙自动分组</h1>
  <div class="sub">
    粘贴接龙 → 自动解析 → 先按顺序分组（不拆分任何人金额）→ 再按组长ID分配给“组里没有该组长ID”的组
  </div>

  <div class="card">
    <div style="font-weight:700;margin-bottom:8px;">① 粘贴接龙</div>
    <textarea id="raw" placeholder="1. 张三 100
2. 李四 20
3. 王五 50"></textarea>

    <div class="row">
      <label>每组金额
        <input id="target" type="number" value="500">
      </label>
      <label>最多补齐人数
        <input id="maxK" type="number" value="6">
      </label>
      <label>
        <input id="showSeq" type="checkbox" checked>
        显示原序号
      </label>
      <button onclick="run()">分组</button>
      <button class="secondary" onclick="clearAll()">清空</button>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;margin-bottom:8px;">② 组长ID列表（每行一个 / 可用逗号分隔也行）</div>
    <textarea id="leaders" class="small" placeholder="例如：
张三
王五"></textarea>
    <div class="note">
      分配规则：分完组后，按组长输入顺序依次分配到<strong>第一个</strong>“组里不包含该组长ID”的组（且该组尚未分配组长）。
      若找不到符合的组，会提示你哪些组长未成功分配。
    </div>
    <div id="assignNote" class="note" style="display:none;"></div>
  </div>

  <div class="card">
    <strong>分组结果</strong>
    <div id="groups" style="margin-top:10px;"></div>
  </div>
</div>

<script>
function parseItems(text){
  const lines=text.replace(/\r/g,"")
    .replace(/(\d+)[\.\、]/g,"\n$1.")
    .split("\n")
    .map(s=>s.trim())
    .filter(Boolean);

  let seq=1;
  const items=[];
  for(let l of lines){
    let m=l.match(/^(\d+)\.\s*/);
    let no=m?parseInt(m[1]):seq;
    if(m) l=l.replace(/^(\d+)\.\s*/,"");

    // 取最后一个数字为金额
    let a=l.match(/(\d+)(?!.*\d)/);
    if(!a) continue;

    let amount=parseInt(a[1],10);
    if(!Number.isFinite(amount) || amount<=0) continue;

    let id=l.replace(a[1],"").trim();
    id=id.replace(/[：:，,。.]$/g,"").trim();
    if(!id) continue;

    items.push({no,id,amount});
    seq=no+1;
  }
  return items;
}

function parseLeaders(text){
  // 支持：换行 / 逗号 / 顿号 / 分号
  return text
    .replace(/\r/g,"")
    .split(/[\n,，;；、]+/g)
    .map(s=>s.trim())
    .filter(Boolean);
}

function findCombo(arr,need,k,start=0,path=[]){
  if(need===0 && path.length===k) return path;
  if(path.length>=k) return null;
  for(let i=start;i<arr.length;i++){
    if(arr[i].amount<=need){
      let r=findCombo(arr,need-arr[i].amount,k,i+1,[...path,i]);
      if(r) return r;
    }
  }
  return null;
}

/**
 * 分配组长：按输入顺序，找“未分配组长的组”里第一个不含该组长ID的组
 * 注意：这里是“包含”判定 => 采用严格相等匹配（组员ID 去空格后与组长ID 去空格后相等）
 */
function assignLeaders(groups, leaderList){
  const norm = s => String(s).trim();

  // 预建每组的成员ID集合（用于快速判断）
  groups.forEach(g=>{
    g.leader = null;
    g.memberSet = new Set(g.items.map(it=>norm(it.id)));
  });

  const unassigned = [];
  for(const leader of leaderList){
    const L = norm(leader);
    let picked = -1;

    for(let i=0;i<groups.length;i++){
      const g = groups[i];
      if(g.leader) continue; // 这组已有组长
      if(g.memberSet.has(L)) continue; // 这组里有该组长的接龙，跳过
      picked = i;
      break;
    }

    if(picked>=0){
      groups[picked].leader = L;
    }else{
      unassigned.push(L);
    }
  }

  // 清理临时字段
  groups.forEach(g=>{ delete g.memberSet; });

  return { groups, unassigned };
}

function run(){
  const raw=document.getElementById("raw").value;
  let arr=parseItems(raw);
  const target=+document.getElementById("target").value;
  const maxK=+document.getElementById("maxK").value;
  const showSeq=document.getElementById("showSeq").checked;

  const leadersText = document.getElementById("leaders").value;
  const leaderList = parseLeaders(leadersText);

  const groups=[];
  while(arr.length){
    let g=[],sum=0;

    // ① 按顺序装入能装下的
    while(arr.length && sum+arr[0].amount<=target){
      g.push(arr.shift());
      sum+=g[g.length-1].amount;
    }

    // ② 不足则从后面找组合补齐（不拆分任何人金额）
    if(sum<target){
      let need=target-sum;
      for(let k=1;k<=maxK;k++){
        let c=findCombo(arr,need,k);
        if(c){
          c.sort((a,b)=>b-a).forEach(i=>g.push(arr.splice(i,1)[0]));
          sum=target;
          break;
        }
      }
    }

    groups.push({sum,items:g});
  }

  // ③ 分完组后：按组长列表分配到不包含组长的组（优先靠前）
  const { groups: assignedGroups, unassigned } = assignLeaders(groups, leaderList);

  render(assignedGroups, showSeq, target, leaderList, unassigned);
}

function render(groups, showSeq, target, leaderList, unassigned){
  // 提示信息
  const note = document.getElementById("assignNote");
  if(leaderList.length){
    note.style.display="block";
    if(unassigned.length){
      note.innerHTML = `<span class="warn">有 ${unassigned.length} 个组长未成功分配：</span>${unassigned.join("、")}
        <br>原因：剩余可分配的组，要么已分配组长，要么包含该组长的接龙。`;
    }else{
      note.innerHTML = `<span class="ok">组长分配完成：</span>共 ${leaderList.length} 位组长，已全部分配到不含本人接龙的组。`;
    }
  }else{
    note.style.display="none";
    note.innerHTML="";
  }

  let html='<div class="groups">';
  groups.forEach((g,i)=>{
    const leaderBadge = g.leader
      ? `<span class="badge">组长：<b>${escapeHtml(g.leader)}</b></span>`
      : (leaderList.length ? `<span class="badge" style="opacity:.75;">未分配组长</span>` : ``);

    html+=`
    <div class="gcard">
      <div class="ghead">
        <div class="left">
          <strong>第 ${i+1} 组</strong>
          ${leaderBadge}
        </div>
        <span class="${g.sum===target?'ok':'warn'}">合计 ${g.sum}</span>
      </div>
      <table>
        <tr>${showSeq?'<th class="seq">序号</th>':''}<th>ID</th><th class="num">金额</th></tr>
        ${g.items.map(it=>`
          <tr>
            ${showSeq?`<td class="seq">${it.no}</td>`:''}
            <td>${escapeHtml(it.id)}</td>
            <td class="num">${it.amount}</td>
          </tr>`).join("")}
      </table>
    </div>`;
  });
  html+='</div>';
  document.getElementById("groups").innerHTML=html;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function clearAll(){
  document.getElementById("raw").value="";
  document.getElementById("leaders").value="";
  document.getElementById("groups").innerHTML="";
  const note=document.getElementById("assignNote");
  note.style.display="none";
  note.innerHTML="";
}
</script>
</body>
</html>

